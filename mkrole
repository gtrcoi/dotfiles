#!/usr/bin/env python3
import functools
import os
import shutil
import sys
from pathlib import Path

SCRIPT_DIR = Path(__file__).parent
SKELETON_DIR = SCRIPT_DIR / ".role_skeleton"

CWD_ROLES_PATH = Path.cwd() / "roles"

ROLE_SUBDIRS = ["tasks", "vars", "meta", "defaults", "files", "templates", "handlers"]


def report_errors(func):
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except Exception as e:
            print(f"Error in {func.__name__}: {e}", file=sys.stderr)
            pass

    return wrapper


@report_errors
def create_role(role_name: str):
    dest_path = CWD_ROLES_PATH / role_name

    if not SKELETON_DIR.exists():
        print(f"Error: Skeleton directory {SKELETON_DIR} not found!", file=sys.stderr)

    for source_file in SKELETON_DIR.rglob("*"):
        relative_path = source_file.relative_to(SKELETON_DIR)
        target_file = dest_path / relative_path

        if source_file.is_dir():
            target_file.mkdir(parents=True, exist_ok=True)

        else:
            if target_file.exists():
                print(f"  Skipped: {relative_path} (already exists)")

            else:
                shutil.copy(source_file, target_file)
                print(f"  Created: {relative_path}")


def main():
    if not os.path.isdir(CWD_ROLES_PATH):
        print(
            f"ERROR: Required directory 'roles' not found at: {CWD_ROLES_PATH}",
            file=sys.stderr,
        )
        sys.exit(1)

    role_args = sys.argv[1:]
    for role_name in role_args:
        create_role(role_name)


if __name__ == "__main__":
    main()
